(function(){var $,Bookmark,Mark,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};$=jQuery,Mark=function(){function Mark(){this.isSending=!1,this.commentNumber=this._getCommentNumber()}return Mark.prototype._getCommentNumber=function(){var commentNumber;return commentNumber=window.location.hash.split("#c")[1],commentNumber=parseInt(commentNumber,10),isNaN(commentNumber)?commentNumber=0:commentNumber-=1,commentNumber},Mark}(),Bookmark=function(){function Bookmark(el,mark,options){this.sendCommentNumber=bind(this.sendCommentNumber,this),this.onWaypoint=bind(this.onWaypoint,this),this.el=$(el),this.mark=mark,this.options=$.extend({},this.defaults,options),this.setUp()}return Bookmark.prototype.defaults={csrfToken:"csrf_token",target:"target url"},Bookmark.prototype.setUp=function(){return this.el.waypoint(this.onWaypoint,{offset:"100%"})},Bookmark.prototype.onWaypoint=function(){var newCommentNumber;newCommentNumber=this.el.data("number"),newCommentNumber>this.mark.commentNumber&&(this.mark.commentNumber=newCommentNumber,this.sendCommentNumber())},Bookmark.prototype.sendCommentNumber=function(){var post,sentCommentNumber;if(!this.mark.isSending)return this.mark.isSending=!0,sentCommentNumber=this.mark.commentNumber,post=$.post(this.options.target,{csrfmiddlewaretoken:this.options.csrfToken,comment_number:this.mark.commentNumber}),post.always(function(_this){return function(){return _this.mark.isSending=!1,_this.mark.commentNumber>sentCommentNumber?_this.sendCommentNumber():void 0}}(this))},Bookmark}(),$.fn.extend({bookmark:function(options){var mark;return mark=new Mark,this.each(function(){return $(this).data("plugin_bookmark")?void 0:$(this).data("plugin_bookmark",new Bookmark(this,mark,options))})}}),$.fn.bookmark.Bookmark=Bookmark,$.fn.bookmark.Mark=Mark}).call(this);